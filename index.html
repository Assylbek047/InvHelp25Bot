<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Private Banking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <!-- –ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cormorant+Garamond:wght@400;600&family=Great+Vibes&family=Inter:wght@300;500&display=swap" rel="stylesheet">

  <style>
    /* ===== –ü–∞–ª–∏—Ç—Ä–∞ Private Banking ===== */
    :root[data-theme="dark"]  { --bg:#0B0F19; --fg:#EAE8E1; --muted:#B2B2B2; --card:#121620; --btn:#C49E63; --good:#1E8E3E; --bad:#C0392B; --border:#2a2f3b; }
    :root[data-theme="light"] { --bg:#F6F5F0; --fg:#0F1115; --muted:#5B6470; --card:#ffffff; --btn:#A67C52; --good:#1E8E3E; --bad:#C0392B; --border:#e3e7ef; }

    * { box-sizing:border-box; }
    html, body { height:100%; margin:0; }
    body { background:var(--bg); color:var(--fg); font-family: Inter, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* ===== –û–±–ª–æ–∂–∫–∞ (welcome) ===== */
    .screen {
      display: none;        /* —ç–∫—Ä–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
      position: absolute;   /* –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –æ–∫–Ω–æ –ø–æ–≤–µ—Ä—Ö –¥—Ä—É–≥–∏—Ö */
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .screen.active {
      display: block;       /* –∞–∫—Ç–∏–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ–º */
    }
    .welcome {
      position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:24px; text-align:center;
      background: radial-gradient(1200px 800px at 60% -10%, #0f1c2e 0%, transparent 60%), linear-gradient(160deg, #0B0F19 0%, #000 90%);
      overflow:hidden;
    }
    .welcome h1 {
      font-family:'Cinzel Decorative', serif; color:var(--btn); font-size:44px; letter-spacing:.5px; margin:0 0 6px;
    }
    .welcome p {
      font-family:'Great Vibes', cursive; color:var(--muted); font-size:22px; margin:0 0 28px;
    }
    .welcome .enter {
      background:var(--btn); color:#fff; border:0; border-radius:14px; padding:12px 22px; font-size:18px; cursor:pointer;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
    }
    /* –ë–ª–µ–¥–Ω—ã–µ —Ç–∏—Å–Ω—ë–Ω—ã–µ —É–∑–æ—Ä—ã (–∞—Å—Ç—Ä–æ–ª—è–±–∏—è+–º–∞—è—Ç–Ω–∏–∫) –∫–∞–∫ watermark */
    .welcome::before, .welcome::after{
      content:""; position:absolute; inset:auto; pointer-events:none; opacity:.18; filter:grayscale(0.2) contrast(1.1);
      background-repeat:no-repeat; background-size:contain;
    }
    /* –ê—Å—Ç—Ä–æ–ª—è–±–∏—è-–∫–æ–º–ø–∞—Å —Å–ª–µ–≤–∞ */
    .welcome::before{
      left:-120px; bottom:-80px; width:520px; height:520px;
      background-image:url('data:image/svg+xml;utf8, \
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 600"> \
          <defs><linearGradient id="g" x1=\"0\" y1=\"0\" x2=\"1\" y2=\"1\"><stop offset=\"0\" stop-color=\"%23C49E63\" stop-opacity=\".25\"/><stop offset=\"1\" stop-color=\"%23C49E63\" stop-opacity=\".05\"/></linearGradient></defs> \
          <circle cx=\"300\" cy=\"300\" r=\"280\" fill=\"none\" stroke=\"url(%23g)\" stroke-width=\"1.5\"/> \
          <circle cx=\"300\" cy=\"300\" r=\"210\" fill=\"none\" stroke=\"url(%23g)\" stroke-width=\"1.2\"/> \
          <circle cx=\"300\" cy=\"300\" r=\"140\" fill=\"none\" stroke=\"url(%23g)\" stroke-width=\"1.2\"/> \
          <g stroke=\"url(%23g)\" stroke-width=\"1\"> \
            <line x1=\"300\" y1=\"20\" x2=\"300\" y2=\"580\"/> \
            <line x1=\"20\"  y1=\"300\" x2=\"580\" y2=\"300\"/> \
            <path d=\"M60,300 A240,240 0 0 1 540,300\" fill=\"none\"/> \
            <path d=\"M300,60 A240,240 0 0 1 300,540\" fill=\"none\"/> \
          </g> \
          <circle cx=\"300\" cy=\"300\" r=\"6\" fill=\"%23C49E63\" fill-opacity=\".3\"/> \
          <path d=\"M300,300 L520,270 L300,330 Z\" fill=\"%23C49E63\" fill-opacity=\".08\"/> \
        </svg>');
    }
    /* –ú–∞—è—Ç–Ω–∏–∫ —Å–ø—Ä–∞–≤–∞ */
    .welcome::after{
      right:-80px; top:-40px; width:420px; height:420px;
      background-image:url('data:image/svg+xml;utf8, \
        <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 400 400\"> \
          <defs><linearGradient id=\"g2\" x1=\"0\" y1=\"0\" x2=\"1\" y2=\"1\"><stop offset=\"0\" stop-color=\"%23C49E63\" stop-opacity=\".22\"/><stop offset=\"1\" stop-color=\"%23C49E63\" stop-opacity=\".06\"/></linearGradient></defs> \
          <path d=\"M200,40 C220,150 260,240 320,320\" fill=\"none\" stroke=\"url(%23g2)\" stroke-width=\"2\"/> \
          <circle cx=\"200\" cy=\"40\" r=\"8\" fill=\"%23C49E63\" fill-opacity=\".25\"/> \
          <circle cx=\"320\" cy=\"320\" r=\"28\" fill=\"%23C49E63\" fill-opacity=\".12\" stroke=\"url(%23g2)\"/> \
        </svg>');
    }

    /* ===== –í–µ—Ä—Ö–Ω—è—è –ø–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ (FAB) –∏ –≤–∫–ª–∞–¥–∫–∏ ===== */
    .app { max-width:760px; margin:0 auto; padding:16px 16px 32px; }
    .tabs { display:flex; gap:8px; margin:6px 0 14px; position:sticky; top:calc(env(safe-area-inset-top) + 8px); z-index:5; }
    .tab { padding:8px 12px; border-radius:999px; border:1px solid var(--border); color:var(--muted); cursor:pointer; backdrop-filter:saturate(120%) blur(8px); background:color-mix(in oklab, var(--card) 85%, transparent); font-family:'Cormorant Garamond', serif; }
    .tab.active { color: var(--fg); background:var(--card); }

    .fab {
      position:fixed; top:calc(env(safe-area-inset-top) + 8px); right:12px; z-index:10;
      display:inline-flex; align-items:center; gap:8px; padding:12px 14px;
      font-size:15px; font-weight:600; background:var(--btn); color:#fff; border:0; border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.25); cursor:pointer; transform:translateY(-6px); opacity:0;
      transition:opacity .28s ease, transform .28s ease, box-shadow .2s ease;
    }
    .fab.show { opacity:1; transform:translateY(0); }
    .fab:active { box-shadow:0 6px 18px rgba(0,0,0,.22); transform:translateY(1px); }

    /* ===== –ö–∞—Ä—Ç–æ—á–∫–∏/–∫–æ–Ω—Ç–µ–Ω—Ç ===== */
    h1 { margin:4px 0 12px; font-size:22px; font-family:'Cormorant Garamond', serif; }
    .muted { color:var(--muted); }
    .row { display:grid; gap:12px; } @media (min-width:640px){ .row.cols-2{ grid-template-columns:1fr 1fr; } }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; background:var(--card); border-radius:12px; border:1px solid var(--border); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; }
    .title { font-weight:600; font-family:'Cormorant Garamond', serif; color:var(--btn); }
    .cta { display:flex; gap:10px; flex-wrap:wrap; }
    .btn { background:var(--btn); color:#fff; border:0; border-radius:12px; padding:12px 14px; font-size:15px; cursor:pointer; }
    .btn.ghost { background:transparent; color:var(--fg); border:1px solid var(--border); }
    .list { display:grid; gap:8px; }
    .item { display:flex; justify-content:space-between; align-items:center; padding:12px; background:var(--card); border:1px solid var(--border); border-radius:12px; }
    .ticker { font-weight:700; letter-spacing:.5px; }
    .chg.pos { color: var(--good); } .chg.neg { color: var(--bad); }

    /* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —ç–∫—Ä–∞–Ω–æ–≤ */
    section.view { opacity:0; transform:translateY(6px); transition:opacity .24s ease, transform .24s ease; }
    section.view.active { opacity:1; transform:none; }

    /* –°–∫–µ–ª–µ—Ç–æ–Ω—ã / –ø—É—Å—Ç—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
    .skeleton { position:relative; overflow:hidden; background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent); }
    .sk-line { height:12px; width:70%; border-radius:6px; background:var(--card); border:1px solid var(--border); margin:8px 0; }
    .empty { text-align:center; padding:24px 12px; color:var(--muted); }
    .chip { display:inline-block; padding:6px 10px; border-radius:999px; border:1px dashed var(--border); color:var(--muted); }

    /* –ò–ò-–∏–Ω—Å–∞–π—Ç—ã —Å—Ç–∏–ª–∏ */
    .insight { background: linear-gradient(135deg, var(--card), color-mix(in oklab, var(--btn) 5%, var(--card))); border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
    .insight-title { font-weight: 600; color: var(--btn); margin-bottom: 6px; }
    .insight-confidence { font-size: 12px; color: var(--muted); }
    .insight-prediction { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .insight-prediction.bullish { background: var(--good); color: white; }
    .insight-prediction.bearish { background: var(--bad); color: white; }
    .insight-prediction.neutral { background: var(--muted); color: white; }

    .build { text-align:center; margin-top:8px; color:var(--muted); font-size:12px; }

    /* –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ */
    .sync-status { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); padding: 8px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; font-size: 12px; z-index: 100; }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <!-- FAB (–≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª) -->
  <button id="fab" class="fab" aria-label="–ì–ª–∞–≤–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>

  <!-- –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
  <div id="sync-status" class="sync-status" style="display: none;">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–æ—Ç–æ–º...</div>

  <!-- –û–ë–õ–û–ñ–ö–ê -->
  <div id="welcome" class="screen welcome active">
    <h1>Private Banking</h1>
    <p>–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</p>
    <button class="enter" onclick="enterApp()">–í–æ–π—Ç–∏</button>
  </div>

  <!-- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
  <div id="app" class="screen" hidden>
    <div class="app">
      <h1>–ò–Ω–≤–µ—Å—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</h1>
      <div class="tabs" id="tabs">
        <div class="tab" data-route="#home">–ì–ª–∞–≤–Ω–∞—è</div>
        <div class="tab" data-route="#watchlist">–ü–æ—Ä—Ç—Ñ–µ–ª—å</div>
        <div class="tab" data-route="#ideas">–ò–Ω—Å–∞–π—Ç—ã</div>
        <div class="tab" data-route="#profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
      </div>

      <!-- –≠–ö–†–ê–ù–´ -->
      <section id="home" class="view" hidden>
        <div class="row cols-2">
          <div class="card">
            <div class="title">–ü–æ—Ä—Ç—Ñ–µ–ª—å —Å–µ–≥–æ–¥–Ω—è</div>
            <div class="pill" id="pill-pl">
              <span>–î–Ω–µ–≤–Ω–æ–π P/L:</span>
              <strong id="pl-val">‚Äî</strong>
            </div>
            <div class="build muted" id="pl-note">–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤—Ö–æ–¥–µ</div>
          </div>
          <div class="card">
            <div class="title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
            <div class="cta">
              <button class="btn" data-action="add_trade">–í–Ω–µ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏—é</button>
              <button class="btn ghost" data-action="add_ticker">–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–∫–µ—Ä</button>
              <button class="btn ghost" data-action="sync_data">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="title">–ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä</div>
          <div class="row" id="home-brief">
            <div class="skeleton sk-line"></div>
            <div class="skeleton sk-line" style="width:50%"></div>
          </div>
        </div>

        <!-- –ò–ò-–∏–Ω—Å–∞–π—Ç—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π -->
        <div class="card" style="margin-top:12px;" id="home-insights">
          <div class="title">üß† –ò–ò-–∏–Ω—Å–∞–π—Ç—ã</div>
          <div id="insights-preview"></div>
        </div>
      </section>

      <section id="watchlist" class="view" hidden>
        <div class="card">
          <div class="title">–ú–æ–π –ü–æ—Ä—Ç—Ñ–µ–ª—å</div>
          <div id="wl-empty" class="empty" hidden>
            –ü–æ–∫–∞ –ø—É—Å—Ç–æ. <span class="chip">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤</span>
          </div>
          <div class="list" id="wl-list"></div>
          <div class="cta" style="margin-top:12px;">
            <button class="btn" data-action="save_portfolio">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–æ—Ç</button>
            <button class="btn ghost" data-action="load_portfolio">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –±–æ—Ç–∞</button>
          </div>
        </div>
      </section>

      <section id="ideas" class="view" hidden>
        <div class="card">
          <div class="title">üß† –ò–ò-–∏–Ω—Å–∞–π—Ç—ã</div>
          <div id="ideas-list" class="list"></div>
          <div id="ideas-empty" class="empty" hidden>–ò–Ω—Å–∞–π—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç ‚Äî –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä—ã–Ω–æ–∫</div>
          <div class="cta" style="margin-top:12px;">
            <button class="btn" data-action="request_insights">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Å–∞–π—Ç—ã</button>
            <button class="btn ghost" data-action="get_insight_for_symbol">üìä –ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–∞</button>
          </div>
        </div>
      </section>

      <section id="profile" class="view" hidden>
        <div class="card">
          <div class="title">–ü—Ä–æ—Ñ–∏–ª—å –∏ —Ä–∏—Å–∫</div>
          <div id="profile-state">
            <div class="empty">
              –ï—â—ë –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ. <span class="chip">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∏—Å–∫-–ø—Ä–æ—Ñ–∏–ª—å</span>
            </div>
          </div>
          <div class="cta" style="margin-top:10px;">
            <button class="btn" data-action="set_risk_low">–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π</button>
            <button class="btn ghost" data-action="set_risk_med">–£–º–µ—Ä–µ–Ω–Ω—ã–π</button>
            <button class="btn ghost" data-action="set_risk_high">–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π</button>
          </div>
          <div class="cta" style="margin-top:10px;">
            <button class="btn ghost" data-action="save_profile">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
          </div>
        </div>
      </section>

      <div class="build">build: private-banking-bot-integration</div>
    </div>
  </div>

  <script>
    // Telegram boot
    const tg = window.Telegram && window.Telegram.WebApp;
    if (tg) {
      tg.ready();
      try { tg.expand(); } catch(_) {}
      document.documentElement.dataset.theme = tg.colorScheme || 'dark';
      try { tg.MainButton.hide(); } catch(_) {}
    } else {
      document.documentElement.dataset.theme = 'dark';
    }
    const haptic = (t='light') => { try { tg.HapticFeedback.impactOccurred(t); } catch(_){} };

    // Store (—Ç–µ–ø–µ—Ä—å —Å –ò–ò-–∏–Ω—Å–∞–π—Ç–∞–º–∏)
    const store = { 
      pl: null, 
      watchlist: [], 
      insights: [],
      risk: null,
      lastSync: null
    };

    // === –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–í–Ø–ó–ò –° –ë–û–¢–û–ú ===
    
    function sendDataToBot(data) {
      if (tg && tg.sendData) {
        try {
          tg.sendData(JSON.stringify(data));
          showSyncStatus('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–æ—Ç ‚úÖ');
        } catch(e) {
          console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±–æ—Ç:', e);
          showSyncStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ‚ùå');
        }
      } else {
        // Fallback –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ Telegram
        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç:', data);
        alert('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–æ—Ç (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)');
      }
    }

    function showSyncStatus(message, duration = 2000) {
      const status = document.getElementById('sync-status');
      status.textContent = message;
      status.style.display = 'block';
      setTimeout(() => {
        status.style.display = 'none';
      }, duration);
    }

    function savePortfolioToBot() {
      const portfolioData = {
        action: 'save_portfolio',
        portfolio: {
          total_value_usd: calculatePortfolioValue(),
          assets: store.watchlist.map(item => ({
            symbol: item.ticker,
            name: item.ticker, // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Ç—É—Ç –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
            type: item.ticker.includes('BTC') || item.ticker.includes('ETH') ? 'crypto' : 'stock',
            quantity: 1, // –ó–∞–≥–ª—É—à–∫–∞ - –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ü–∏–π
            current_price: item.price,
            pnl_percent: item.chg,
            last_updated: new Date().toISOString()
          })),
          last_updated: new Date().toISOString()
        }
      };
      sendDataToBot(portfolioData);
    }

    function requestAIInsight(symbol = null) {
      const requestData = {
        action: 'request_insight',
        symbol: symbol || (store.watchlist[0] ? store.watchlist[0].ticker : 'AAPL')
      };
      sendDataToBot(requestData);
    }

    function setAlertForSymbol(symbol, targetPrice) {
      const alertData = {
        action: 'set_alert',
        symbol: symbol,
        target_price: targetPrice
      };
      sendDataToBot(alertData);
    }

    function saveProfileToBot() {
      if (!store.risk) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∏—Å–∫-–ø—Ä–æ—Ñ–∏–ª—å');
        return;
      }
      const profileData = {
        action: 'save_profile',
        profile: {
          risk_tolerance: store.risk,
          language: 'ru',
          updated_at: new Date().toISOString()
        }
      };
      sendDataToBot(profileData);
    }

    function calculatePortfolioValue() {
      return store.watchlist.reduce((sum, item) => sum + item.price, 0);
    }

    // FAB
    const fab = document.getElementById('fab');
    function setFab(text, onClick){ fab.textContent=text; fab.onclick=()=>{haptic(); onClick&&onClick();}; }
    function showFab(show=true){ fab.classList.toggle('show', show); }

    // Router
    const routes = ['#home','#watchlist','#ideas','#profile'];
    function show(hash){
      if (!routes.includes(hash)) hash = '#home';

      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.route===hash));
      routes.forEach(r => {
        const el = document.querySelector(r);
        if (!el) return;
        const active = (r===hash);
        el.hidden = !active;
        el.classList.toggle('active', active);
      });
      if (tg && tg.BackButton) (hash!=='#home') ? tg.BackButton.show() : tg.BackButton.hide();

      if (hash==='#home'){ setFab('–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é', ()=>alert('–ó–∞–≥–ª—É—à–∫–∞: —Ñ–æ—Ä–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏')); showFab(true); }
      else if (hash==='#watchlist'){ setFab('–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–∫–µ—Ä', addMockTicker); showFab(true); }
      else if (hash==='#ideas'){ setFab('–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∏–Ω—Å–∞–π—Ç', ()=>requestAIInsight()); showFab(true); }
      else if (hash==='#profile'){ setFab('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å', saveProfileToBot); showFab(true); }

      render(hash);
    }

    // Screens render
    function render(hash){
      if (hash==='#home') renderHome();
      if (hash==='#watchlist') renderWatchlist();
      if (hash==='#ideas') renderIdeas();
      if (hash==='#profile') renderProfile();
    }

    function renderHome(){
      const pill=document.getElementById('pill-pl');
      const plEl=document.getElementById('pl-val');
      const brief=document.getElementById('home-brief');
      const insightsPreview = document.getElementById('insights-preview');
      
      plEl.textContent='‚Ä¶';
      brief.innerHTML=`<div class="skeleton sk-line"></div><div class="skeleton sk-line" style="width:55%"></div>`;
      
      setTimeout(()=>{
        if (store.pl==null){ const val=(Math.random()*2-1)*3.7; store.pl=val; }
        const v=store.pl;
        plEl.textContent=(v>=0?'+':'')+v.toFixed(2)+'%';
        pill.style.borderColor=v>=0?'var(--good)':'var(--bad)';
        pill.style.boxShadow=v>=0?'0 0 0 1px var(--good) inset':'0 0 0 1px var(--bad) inset';
        brief.innerHTML=`<div class="muted">–ê–∫—Ç–∏–≤–æ–≤: ${store.watchlist.length||0}</div>
                         <div class="muted">–†–∏—Å–∫-–ø—Ä–æ—Ñ–∏–ª—å: ${store.risk?mapRisk(store.risk):'–Ω–µ –≤—ã–±—Ä–∞–Ω'}</div>`;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é –∏–Ω—Å–∞–π—Ç–æ–≤
        if (store.insights.length > 0) {
          const latestInsight = store.insights[0];
          insightsPreview.innerHTML = `
            <div class="insight">
              <div class="insight-title">${latestInsight.title}</div>
              <div class="muted">${latestInsight.summary}</div>
              <div style="margin-top: 8px;">
                <span class="insight-prediction ${latestInsight.prediction}">${mapPrediction(latestInsight.prediction)}</span>
                <span class="insight-confidence">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${Math.round(latestInsight.confidence * 100)}%</span>
              </div>
            </div>
          `;
        } else {
          insightsPreview.innerHTML = '<div class="muted">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∏–Ω—Å–∞–π—Ç–æ–≤</div>';
        }
      },450);
    }

    function renderWatchlist(){
      const list=document.getElementById('wl-list');
      const empty=document.getElementById('wl-empty');
      if (!store.watchlist.length){ empty.hidden=false; list.innerHTML=''; return; }
      empty.hidden=true;
      list.innerHTML=store.watchlist.map(a=>{
        const chgCls=a.chg>=0?'chg pos':'chg neg';
        const chgStr=(a.chg>=0?'+':'')+a.chg.toFixed(2)+'%';
        return `<div class="item">
          <div><div class="ticker">${a.ticker}</div>
          <div class="muted">$${a.price.toFixed(2)}</div></div>
          <div class="${chgCls}">${chgStr}</div>
        </div>`;
      }).join('');
    }

    function renderIdeas(){
      const list=document.getElementById('ideas-list');
      const empty=document.getElementById('ideas-empty');
      if (!store.insights.length){ empty.hidden=false; list.innerHTML=''; return; }
      empty.hidden=true;
      list.innerHTML=store.insights.map(insight=>`
        <div class="insight">
          <div class="insight-title">${insight.title}</div>
          <div class="muted" style="margin: 6px 0;">${insight.summary}</div>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span class="insight-prediction ${insight.prediction}">${mapPrediction(insight.prediction)}</span>
              <span class="insight-confidence" style="margin-left: 8px;">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${Math.round(insight.confidence * 100)}%</span>
            </div>
            <button class="btn ghost" onclick="haptic(); requestAIInsight('${insight.symbol || 'AAPL'}');">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>`).join('');
    }

    function renderProfile(){
      const box=document.getElementById('profile-state');
      box.innerHTML = !store.risk
        ? `<div class="empty">–ï—â—ë –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ. <span class="chip">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∏—Å–∫-–ø—Ä–æ—Ñ–∏–ª—å</span></div>`
        : `<div class="pill">–¢–µ–∫—É—â–∏–π —Ä–∏—Å–∫-–ø—Ä–æ—Ñ–∏–ª—å: <strong>${mapRisk(store.risk)}</strong></div>
           <div class="muted" style="margin-top:8px;">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å –±–æ—Ç–æ–º: ${store.lastSync || '–Ω–∏–∫–æ–≥–¥–∞'}</div>`;
    }

    // Actions (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –±–æ—Ç–∞)
    function addMockTicker(){
      const sample=['AAPL','MSFT','NVDA','SPY','TSLA','GOOGL','AMZN','BTC','ETH'];
      const t=sample[Math.floor(Math.random()*sample.length)];
      const price=(Math.random()*3000)+10;
      const chg=(Math.random()*2-1)*5;
      store.watchlist.push({ticker:t, price, chg});
      renderWatchlist();
      if (tg) tg.showPopup({title:'–î–æ–±–∞–≤–ª–µ–Ω–æ', message:`${t} –≤ –ø–æ—Ä—Ç—Ñ–µ–ª—å`, buttons:[{type:'ok'}]});
    }

    function loadMockInsights(){
      store.insights=[
        {
          title:'Apple: –Ω–æ–≤—ã–µ AirPods —Å –ò–ò',
          summary:'–ó–∞–ø—É—Å–∫ –Ω–æ–≤—ã—Ö AirPods –º–æ–∂–µ—Ç —É–≤–µ–ª–∏—á–∏—Ç—å –≤—ã—Ä—É—á–∫—É –Ω–∞ 5-7%',
          prediction:'bullish',
          confidence:0.85,
          symbol:'AAPL'
        },
        {
          title:'Tesla: —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤ –ê–∑–∏–∏',
